<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicacion de Registro Academico</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<style>
    body {
            background-color: #76b852;
        }
    
    </style>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col col-md-6">
                <div class="card text-white bg-dark mb-3">
                    <div class="card-header">REGISTRO DOCENTE</div>
                    <div class="card-body">
                        <form id="frmDocentes" data-accion="nuevo" data-iddocente="0">
                            <div class="mb-2 row">
                                <input autocomplete="off" id="txtCodigoDocentes" required
                                    pattern="^([USIS|USLI|USLA]){4}[0-9]{6}" placeholder="Codigo" type="text"
                                    aria-label="Codigo" class="form-control">
                            </div>
                            <div class="mb-2 row">
                                <input id="txtNombreDocentes" required pattern="[A-Za-zÑñáéíóú ]{6,65}"
                                    placeholder="Nombre" type="text" aria-label="Nombre" class="form-control">
                            </div>
                            <div class="mb-2 row">
                                <input id="txtTelefonoDocentes" required pattern="[0-9]{4}([-| ]){1}[0-9]{4}"
                                    placeholder="Telefono" type="text" aria-label="Tels" class="form-control">
                            </div>
                            <div class="mb-2 row">
                                <button type="submit" class="btn btn-outline-primary text-white">REGISTRAR</button>
                                <button type="reset" class="btn btn-outline-warning text-white">NUEVO</button>
                                <a href="http://localhost:3000/" class="btn btn-primary text-white">REGRESAR</a>
                            </div>
                            <div id="alerta" class="alert alert-success d-none" role="alert">Hola</div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col col-md-6">
                <div class="card text-white bg-dark mb-3">
                    <div class="card-header">CONSULTA DE DOCENTES</div>
                    <div class="card-body">
                        <form id="frmConsultaDocentes">
                            <table id="tblConsultaDocentes" class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th colspan="4">
                                            <input class="form-control" placeholder="Buscar docentes" type="text"
                                                name="txtBuscarDocentes" id="txtBuscarDocentes" />
                                        </th>
                                    </tr>
                                    <tr>
                                        <th scope="col">Codigo</th>
                                        <th scope="col">Nombre</th>
                                        <th scope="col">Telefono</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
    </script>
    <script>
        function mostrarDatosDocentes(docente) {
            $("#frmDocentes")
                .data("accion", "modificar")
                .data("iddocente", docente.idDocente);
            $("#txtCodigoDocentes").val(docente.codigo);
            $("#txtNombreDocentes").val(docente.nombre);
            $("#txtTelefonoDocentes").val(docente.telefono);
        }

        function limpiarFormulario() {
            $("#frmDocentes")
                .data("accion", "nuevo")
                .data("iddocente", 0);
            $("#frmDocentes input[type=text]").val('');
        }

        function eliminarDocente(docente) {
            if (confirm(`Esta seguro de eliminar el docente ${docente.nombre}?`)) {
                let datos = {
                    accion: "eliminar",
                    idDocente: docente.idDocente
                };
                $.post("http://localhost:3000/docente", JSON.stringify(datos), (data, status) => {
                    limpiarFormulario();
                    mostrarMsg(data.resp);
                    obtenerDatosDocentes();
                }, "json");
            }
        }

        function mostrarMsg(msg) {
            $("#alerta")
                .text(msg)
                .toggleClass("d-none");

            setTimeout(() => {
                $("#alerta").toggleClass("d-none");
            }, 5000);
        }

        function obtenerDatosDocentes() {
            $.get("http://localhost:3000/consulta", (resp, status) => {
                let tbody = $("#tblConsultaDocentes > tbody"),
                    filas = "";
                tbody.find("tr").remove();
                if (resp.data.length > 0) {
                    resp.data.forEach(docente => {
                        filas += `
                            <tr onClick='mostrarDatosDocentes(${JSON.stringify(docente)})'>
                                <td>${docente.codigo}</td>
                                <td>${docente.nombre}</td>
                                <td>${docente.telefono}</td>
                                <td>
                                    <a class="btn btn-outline-danger" onClick='eliminarDocente(${JSON.stringify(docente)})'>Eliminar</a>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    filas = `
                        <tr>
                            <td colspan="3">No hay docentes para mostrar</td>
                        </tr>
                    `;
                }
                tbody.append(filas);
            }, "json");
        }
        $(document).ready(e => {
            $("#txtBuscarDocentes").keyup(function (e) {
                let valor = $(this).val(),
                    $tbldocentes = $("#tblConsultaDocentes > tbody > tr");
                $tbldocentes.show();
                let $no_encontrados = $tbldocentes.filter(function (i, fila) {
                    return $(this).find("td:not(:last)").text().toLowerCase().indexOf(valor
                        .toLowerCase()) == -1;
                });
                $no_encontrados.hide();
            });
            $("#frmDocentes")
                .on("reset", e => {
                    limpiarFormulario();
                })
                .submit(e => {
                    e.preventDefault();

                    let accion = $("#frmDocentes").data("accion"),
                        idDocente = $("#frmDocentes").data("iddocente"),
                        codigo = $("#txtCodigoDocentes").val(),
                        nombre = $("#txtNombreDocentes").val(),
                        telefono = $("#txtTelefonoDocentes").val(),
                        datos = {
                            accion,
                            idDocente,
                            codigo,
                            nombre,
                            telefono
                        };

                    $.post("http://localhost:3000/docentes", JSON.stringify(datos), (data, status) => {
                        if (data.resp.indexOf("Error") == -1) {
                            limpiarFormulario();
                            obtenerDatosDocentes();

                            $("#alerta")
                                .removeClass("alert-danger")
                                .addClass("alert-success");
                        } else {
                            $("#alerta")
                                .removeClass("alert-success")
                                .addClass("alert-danger");
                        }
                        mostrarMsg(data.resp);
                    }, "json");
                });
            obtenerDatosDocentes();
        });
    </script>
</body>

</html>